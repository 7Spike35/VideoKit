{% extends "base.html" %}
{% block title %}æˆ‘çš„æ”¶è—{% endblock %}
{% block content %}
<div class="container">
    <h1>â¤ï¸ æˆ‘çš„æ”¶è—</h1>
    <a href="/" class="back-btn">è¿”å›æœç´¢</a>

    <!-- è§†é¢‘æ”¶è— -->
    <div class="section-title">è§†é¢‘æ”¶è—</div>
    {% if not video_favorites %}
        <div class="no-favorites">
            ğŸ‘œ è§†é¢‘æ”¶è—å¤¹æ˜¯ç©ºçš„ï¼Œå¿«å»æ”¶è—å–œæ¬¢çš„è§†é¢‘å§ï¼
        </div>
    {% else %}
        <div class="result-stats">
            å…± {{ video_total }} é¡¹è§†é¢‘æ”¶è—
        </div>
        <table class="favorite-table">
            <thead>
                <tr>
                    <th>è§†é¢‘åç§°</th>
                    <th>çƒ­åº¦å€¼</th>
                    <th>è§†é¢‘é“¾æ¥</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="video-favorite-tbody">
                {% for item in video_favorites %}
                <tr>
                    <td class="video-title">{{ item.title }}</td>
                    <td>{{ "%.1f"|format(item.heat) }}</td>
                    <td>
                        <a href="https://www.bilibili.com/video/{{ item.id }}" target="_blank">
                            è§‚çœ‹è§†é¢‘
                        </a>
                    </td>
                    <td>
                        <button class="remove-btn" data-id="{{ item.id }}" data-type="video">å–æ¶ˆæ”¶è—</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="pagination" id="video-pagination"></div>
    {% endif %}

    <!-- ç›´æ’­æ”¶è— -->
    <div class="section-title">
        ç›´æ’­æ”¶è—
        {% if live_count > 0 %}
            <a href="{{ url_for('live_analysis') }}" class="analysis-btn" onclick="return triggerCrawl(this)">ğŸ“Š è¯¦ç»†æŠ¥å‘Š</a>
        {% endif %}
    </div>
    {% if not live_favorites %}
        <div class="no-favorites">
            ğŸ‘œ ç›´æ’­æ”¶è—å¤¹æ˜¯ç©ºçš„ï¼Œå¿«å»æ”¶è—å–œæ¬¢çš„ç›´æ’­å§ï¼
        </div>
    {% else %}
        <div class="result-stats">
            å…± {{ live_total }} é¡¹ç›´æ’­æ”¶è—
        </div>
        <table class="favorite-table">
            <thead>
                <tr>
                    <th>ç›´æ’­æ ‡é¢˜</th>
                    <th>äººæ°”</th>
                    <th>ç›´æ’­çŠ¶æ€</th>
                    <th>ç›´æ’­é“¾æ¥</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody id="live-favorite-tbody">
                {% for item in live_favorites %}
                <tr>
                    <td class="video-title">{{ item.title }}</td>
                    <td>{{ "%.0f"|format(item.heat) }}</td>
                    <td class="live-status {{ 'live' if item.is_live else '' }}">
                        {{ 'æ­£åœ¨ç›´æ’­' if item.is_live else 'æœªå¼€æ’­' }}
                    </td>
                    <td>
                        <a href="https://live.bilibili.com/{{ item.id }}" target="_blank">
                            è§‚çœ‹ç›´æ’­
                        </a>
                    </td>
                    <td>
                        <button class="remove-btn" data-id="{{ item.id }}" data-type="live">å–æ¶ˆæ”¶è—</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        <div class="pagination" id="live-pagination"></div>
    {% endif %}
</div>

<style>
    .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 40px;
        text-align: center;
    }

    h1 {
        font-size: 2.5em;
        color: #333;
        margin-bottom: 20px;
    }

    .back-btn {
        text-decoration: none;
        color: #00a1d6;
        background-color: #fff;
        font-size: 1.1em;
        padding: 8px 16px;
        border: 1px solid #00a1d6;
        border-radius: 4px;
        transition: background-color 0.3s, color 0.3s;
        display: inline-block;
        margin-bottom: 20px;
    }

    .back-btn:hover {
        background-color: #e0f7fa;
        color: #0083b0;
    }

    .analysis-btn {
        text-decoration: none;
        color: #fff;
        background: linear-gradient(135deg, #00a1d6 0%, #4dc3ff 100%);
        font-size: 1.1em;
        font-weight: 600;
        padding: 8px 16px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        margin-left: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s, background 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .analysis-btn:hover {
        background: linear-gradient(135deg, #4dc3ff 0%, #00a1d6 100%);
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0, 161, 214, 0.3);
    }

    .analysis-btn:active {
        transform: scale(0.95);
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .analysis-btn.disabled {
        background: #ccc;
        color: #666;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    .analysis-btn.disabled:hover {
        background: #ccc;
        box-shadow: none;
        transform: none;
    }

    .no-favorites {
        font-size: 1.2em;
        color: #666;
        margin: 20px 0;
    }

    .favorite-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

    .favorite-table th, .favorite-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
    }

    .favorite-table th {
        background-color: #f9f9f9;
        font-size: 1.1em;
        color: #333;
    }

    .favorite-table td {
        font-size: 1em;
        color: #666;
    }

    .video-title {
        max-width: 400px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .live-status {
        color: #00a1d6;
    }

    .live-status:not(.live) {
        color: #666;
    }

    .favorite-table a {
        color: #00a1d6;
        text-decoration: none;
    }

    .favorite-table a:hover {
        text-decoration: underline;
    }

    .remove-btn {
        padding: 8px 16px;
        font-size: 1em;
        background-color: #fff;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .remove-btn:hover {
        background-color: #ffebee;
        color: #d32f2f;
    }

    .pagination {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
    }

    .pagination a {
        text-decoration: none;
        color: #00a1d6;
        padding: 8px 12px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        transition: background-color 0.3s;
    }

    .pagination a.active {
        background-color: #00a1d6;
        color: white;
        border-color: #00a1d6;
    }

    .pagination a:hover:not(.active) {
        background-color: #e0f7fa;
    }

    .section-title {
        font-size: 1.8em;
        color: #333;
        margin: 30px 0 15px;
        display: flex;
        align-items: center;
    }
</style>

<script>
    const ITEMS_PER_PAGE = 10;
    const videoTotalItems = {{ video_total }};
    const liveTotalItems = {{ live_total }};
    const videoTotalPages = Math.ceil(videoTotalItems / ITEMS_PER_PAGE);
    const liveTotalPages = Math.ceil(liveTotalItems / ITEMS_PER_PAGE);

    function triggerCrawl(element) {
        const btn = element;
        if (btn.classList.contains('disabled')) {
            alert('çˆ¬å–å†·å´ä¸­ï¼Œè¯·ç¨åé‡è¯•');
            return false;
        }

        btn.classList.add('disabled');
        fetch('/trigger_crawl', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log(data.message);
                setTimeout(() => btn.classList.remove('disabled'), 60000); // 60ç§’å†·å´
                return true; // å…è®¸è·³è½¬
            } else {
                alert('è§¦å‘çˆ¬å–å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                btn.classList.remove('disabled');
                return false; // é˜»æ­¢è·³è½¬
            }
        })
        .catch(error => {
            console.error('Crawl error:', error);
            alert('è§¦å‘çˆ¬å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•');
            btn.classList.remove('disabled');
            return false; // é˜»æ­¢è·³è½¬
        });
        return true; // é»˜è®¤å…è®¸è·³è½¬
    }

    function renderPagination(containerId, currentPage, totalPages, type) {
        const pagination = document.getElementById(containerId);
        pagination.innerHTML = '';

        if (currentPage > 1) {
            const prev = document.createElement('a');
            prev.href = '#';
            prev.textContent = 'Â«';
            prev.addEventListener('click', (e) => {
                e.preventDefault();
                loadPage(currentPage - 1, type);
            });
            pagination.appendChild(prev);
        }

        const startPage = Math.max(1, currentPage - 2);
        const endPage = Math.min(totalPages, currentPage + 2);
        for (let i = startPage; i <= endPage; i++) {
            const pageLink = document.createElement('a');
            pageLink.href = '#';
            pageLink.textContent = i;
            if (i === currentPage) {
                pageLink.classList.add('active');
            }
            pageLink.addEventListener('click', (e) => {
                e.preventDefault();
                loadPage(i, type);
            });
            pagination.appendChild(pageLink);
        }

        if (currentPage < totalPages) {
            const next = document.createElement('a');
            next.href = '#';
            next.textContent = 'Â»';
            next.addEventListener('click', (e) => {
                e.preventDefault();
                loadPage(currentPage + 1, type);
            });
            pagination.appendChild(next);
        }
    }

    function loadPage(page, type) {
        console.log(`Loading ${type} favorites page ${page}`);
        fetch('/favorites_page', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                page: page,
                items_per_page: ITEMS_PER_PAGE,
                type: type
            })
        })
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Received data:', data);
            if (data.error) {
                alert('åŠ è½½åˆ†é¡µæ•°æ®å¤±è´¥ï¼š' + data.error);
                return;
            }

            const tbody = document.getElementById(`${type}-favorite-tbody`);
            tbody.innerHTML = '';
            if (data.favorites.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${type === 'video' ? 4 : 5}">æ— æ•°æ®</td></tr>`;
            } else {
                data.favorites.forEach(item => {
                    const tr = document.createElement('tr');
                    if (type === 'video') {
                        tr.innerHTML = `
                            <td class="video-title">${item.title}</td>
                            <td>${item.heat.toFixed(1)}</td>
                            <td><a href="https://www.bilibili.com/video/${item.id}" target="_blank">è§‚çœ‹è§†é¢‘</a></td>
                            <td><button class="remove-btn" data-id="${item.id}" data-type="video">å–æ¶ˆæ”¶è—</button></td>
                        `;
                    } else {
                        tr.innerHTML = `
                            <td class="video-title">${item.title}</td>
                            <td>${item.heat.toFixed(0)}</td>
                            <td class="live-status ${item.is_live ? 'live' : ''}">${item.is_live ? 'æ­£åœ¨ç›´æ’­' : 'æœªå¼€æ’­'}</td>
                            <td><a href="https://live.bilibili.com/${item.id}" target="_blank">è§‚çœ‹ç›´æ’­</a></td>
                            <td><button class="remove-btn" data-id="${item.id}" data-type="live">å–æ¶ˆæ”¶è—</button></td>
                        `;
                    }
                    tbody.appendChild(tr);
                });
            }

            renderPagination(`${type}-pagination`, page, type === 'video' ? videoTotalPages : liveTotalPages, type);
            bindRemoveButtons();
        })
        .catch(error => {
            console.error('Fetch error:', error);
            alert('åŠ è½½åˆ†é¡µæ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•');
        });
    }

    function bindRemoveButtons() {
        document.querySelectorAll('.remove-btn').forEach(button => {
            button.addEventListener('click', () => {
                const id = button.dataset.id;
                const type = button.dataset.type;
                fetch('/remove_favorite', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ id, type })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const totalItems = type === 'video' ? videoTotalItems : liveTotalItems;
                        const totalPages = type === 'video' ? videoTotalPages : liveTotalPages;
                        let currentPage = Math.ceil(totalItems / ITEMS_PER_PAGE);
                        if (totalItems <= (currentPage - 1) * ITEMS_PER_PAGE && currentPage > 1) {
                            currentPage -= 1;
                        }
                        loadPage(currentPage, type);
                    } else {
                        alert('å–æ¶ˆæ”¶è—å¤±è´¥ï¼š' + (data.error || 'æœªçŸ¥é”™è¯¯'));
                    }
                })
                .catch(error => {
                    console.error('Remove error:', error);
                    alert('å–æ¶ˆæ”¶è—å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åé‡è¯•');
                });
            });
        });
    }

    if (videoTotalItems > 0) {
        renderPagination('video-pagination', 1, videoTotalPages, 'video');
        bindRemoveButtons();
    }
    if (liveTotalItems > 0) {
        renderPagination('live-pagination', 1, liveTotalPages, 'live');
        bindRemoveButtons();
    }
</script>
{% endblock %}